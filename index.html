<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEENOS 2025 Attendance QR System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-success { animation: pulseSuccess 0.6s ease-in-out; }
        @keyframes pulseSuccess { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .scanner-frame { border: 3px solid #10b981; border-radius: 12px; position: relative; }
        .scanner-corners::before, .scanner-corners::after { content: ''; position: absolute; width: 20px; height: 20px; border: 3px solid #10b981; }
        .scanner-corners::before { top: -3px; left: -3px; border-right: none; border-bottom: none; }
        .scanner-corners::after { bottom: -3px; right: -3px; border-left: none; border-top: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <nav class="bg-black bg-opacity-30 backdrop-blur-md p-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">üéâ BEENOS 2025 Check-In</h1>
            <div class="space-x-4">
                <button onclick="showView('guest')" class="nav-btn bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">Guest</button>
                <button onclick="showView('scanner')" class="nav-btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">Scanner</button>
                <button onclick="showView('admin')" class="nav-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">Admin</button>
            </div>
        </div>
    </nav>

    <div id="guestView" class="view-container max-w-md mx-auto p-6 mt-8">
        <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-2xl p-8 text-center fade-in">
            <div id="guestLogin" class="guest-section">
                <h2 class="text-3xl font-bold text-white mb-6">üé´ Get Your QR Code</h2>
                <p class="text-gray-200 mb-6">Enter your email to generate your BEENOS 2025 entry QR code</p>
                <input type="email" id="guestEmail" placeholder="your.email@example.com" 
                        class="w-full p-4 rounded-xl bg-white bg-opacity-20 text-white placeholder-gray-300 border border-white border-opacity-30 focus:outline-none focus:ring-2 focus:ring-purple-400 mb-4">
                <button onclick="generateQR()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105">
                    Generate QR Code ‚ú®
                </button>
            </div>
            
            <div id="guestQR" class="guest-section hidden">
                <h2 class="text-2xl font-bold text-white mb-4">Your Entry QR Code</h2>
                <div class="bg-white p-6 rounded-2xl mb-4">
                    <canvas id="qrCanvas" class="mx-auto"></canvas>
                </div>
                <p class="text-gray-200 mb-4">Show this QR code at the entrance</p>
                <p id="guestEmailDisplay" class="text-purple-300 font-semibold mb-4"></p>
                <button onclick="showGuestLogin()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">
                    Generate New Code
                </button>
            </div>
        </div>
    </div>

    <div id="scannerView" class="view-container max-w-2xl mx-auto p-6 mt-8 hidden">
        <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-2xl p-8 fade-in">
            <h2 class="text-3xl font-bold text-white text-center mb-6">üì± QR Code Scanner</h2>
            
            <div id="scannerInterface">
                <div class="scanner-frame scanner-corners bg-black rounded-xl overflow-hidden mb-4">
                    <div id="qr-reader" class="w-full h-80"></div>
                </div>
                
                <div class="text-center">
                    <button id="startScanBtn" onclick="startScanner()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl transition-all">
                        üéØ Start Scanner
                    </button>
                    <button id="stopScanBtn" onclick="stopScanner()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-xl transition-all hidden ml-4">
                        ‚èπÔ∏è Stop Scanner
                    </button>
                </div>
            </div>

            <div id="scanResult" class="hidden mt-6 p-6 bg-green-500 bg-opacity-20 border border-green-400 rounded-xl text-center">
                <h3 class="text-xl font-bold text-green-300 mb-2">‚úÖ Guest Checked In!</h3>
                <p id="scannedEmail" class="text-white text-lg"></p>
                <p id="scanTime" class="text-green-200 text-sm mt-2"></p>
            </div>

            <div id="scanError" class="hidden mt-6 p-6 bg-red-500 bg-opacity-20 border border-red-400 rounded-xl text-center">
                <h3 class="text-xl font-bold text-red-300 mb-2">‚ùå Scan Error</h3>
                <p id="errorMessage" class="text-white"></p>
            </div>
        </div>
    </div>

    <div id="adminView" class="view-container max-w-6xl mx-auto p-6 mt-8 hidden">
        <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-2xl p-8 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">üìä Admin Dashboard</h2>
                <div class="space-x-4">
                    <button onclick="refreshAttendance()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üîÑ Refresh
                    </button>
                    <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üì• Export CSV
                    </button>
                    <button onclick="clearData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        üóëÔ∏è Clear Data
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-purple-600 bg-opacity-30 p-6 rounded-xl text-center">
                    <h3 class="text-lg font-semibold text-purple-200">Total Registered</h3>
                    <p id="totalUsers" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="bg-green-600 bg-opacity-30 p-6 rounded-xl text-center">
                    <h3 class="text-lg font-semibold text-green-200">Checked In</h3>
                    <p id="totalCheckedIn" class="text-3xl font-bold text-white">0</p>
                </div>
                <div class="bg-blue-600 bg-opacity-30 p-6 rounded-xl text-center">
                    <h3 class="text-lg font-semibold text-blue-200">Check-in Rate</h3>
                    <p id="checkinRate" class="text-3xl font-bold text-white">0%</p>
                </div>
            </div>

            <div class="bg-black bg-opacity-30 rounded-xl overflow-hidden">
                <div class="p-4 bg-gray-800 bg-opacity-50">
                    <h3 class="text-xl font-bold text-white">Recent Check-ins</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-white">
                        <thead class="bg-gray-700 bg-opacity-50">
                            <tr>
                                <th class="px-6 py-3 text-left">Email</th>
                                <th class="px-6 py-3 text-left">Check-in Time</th>
                                <th class="px-6 py-3 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTable" class="divide-y divide-gray-600">
                            <tr>
                                <td colspan="3" class="px-6 py-8 text-center text-gray-400">No check-ins yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let users = JSON.parse(localStorage.getItem('beenosUsers') || '[]');
        let attendanceLogs = JSON.parse(localStorage.getItem('beenosAttendanceLogs') || '[]');
        let html5QrCode = null;

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.view-container').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewName + 'View').classList.remove('hidden');
            
            if (viewName === 'admin') {
                refreshAttendance();
            }
            if (viewName === 'scanner') {
                stopScanner();
            }
        }

        // Guest Functions
        function generateQR() {
            const email = document.getElementById('guestEmail').value.trim();
            
            if (!email || !isValidEmail(email)) {
                alert('Please enter a valid email address');
                return;
            }

            // Check if user already exists
            let user = users.find(u => u.email === email);
            if (!user) {
                user = {
                    id: Date.now().toString(),
                    email: email,
                    registeredAt: new Date().toISOString()
                };
                users.push(user);
                localStorage.setItem('beenosUsers', JSON.stringify(users));
            }

            // Generate QR Code
            const qrData = JSON.stringify({ email: email, id: user.id });
            const canvas = document.getElementById('qrCanvas');
            
            QRCode.toCanvas(canvas, qrData, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    alert('Error generating QR code');
                    return;
                }
                
                document.getElementById('guestEmailDisplay').textContent = email;
                document.getElementById('guestLogin').classList.add('hidden');
                document.getElementById('guestQR').classList.remove('hidden');
            });
        }

        function showGuestLogin() {
            document.getElementById('guestQR').classList.add('hidden');
            document.getElementById('guestLogin').classList.remove('hidden');
            document.getElementById('guestEmail').value = '';
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Scanner Functions
        function startScanner() {
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                document.getElementById('startScanBtn').classList.add('hidden');
                document.getElementById('stopScanBtn').classList.remove('hidden');
                hideResults();
            }).catch(err => {
                console.error('Scanner start error:', err);
                showError('Camera access denied or not available');
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('startScanBtn').classList.remove('hidden');
                    document.getElementById('stopScanBtn').classList.add('hidden');
                }).catch(err => {
                    console.error('Scanner stop error:', err);
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            try {
                const qrData = JSON.parse(decodedText);
                const email = qrData.email;
                const userId = qrData.id;

                // Verify user exists
                const user = users.find(u => u.email === email && u.id === userId);
                if (!user) {
                    showError('Invalid QR code - user not found');
                    return;
                }

                // Check if already checked in recently (within 5 minutes to prevent double scans)
                const recentScan = attendanceLogs.find(log => 
                    log.email === email && 
                    (Date.now() - new Date(log.timestamp).getTime()) < 300000
                );

                if (recentScan) {
                    showError('Already checked in recently');
                    return;
                }

                // Log attendance
                const attendanceLog = {
                    id: Date.now().toString(),
                    email: email,
                    userId: userId,
                    timestamp: new Date().toISOString(),
                    scannedBy: 'Receptionist'
                };

                attendanceLogs.push(attendanceLog);
                localStorage.setItem('beenosAttendanceLogs', JSON.stringify(attendanceLogs));

                showScanSuccess(email, attendanceLog.timestamp);
                
                // Auto-hide success message after 3 seconds
                setTimeout(hideResults, 3000);

            } catch (error) {
                showError('Invalid QR code format');
            }
        }

        function onScanFailure(error) {
            // Silent failure for continuous scanning
        }

        function showScanSuccess(email, timestamp) {
            hideResults();
            document.getElementById('scannedEmail').textContent = email;
            document.getElementById('scanTime').textContent = new Date(timestamp).toLocaleString();
            document.getElementById('scanResult').classList.remove('hidden');
            document.getElementById('scanResult').classList.add('pulse-success');
        }

        function showError(message) {
            hideResults();
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('scanError').classList.remove('hidden');
        }

        function hideResults() {
            document.getElementById('scanResult').classList.add('hidden');
            document.getElementById('scanError').classList.add('hidden');
            document.getElementById('scanResult').classList.remove('pulse-success');
        }

        // Admin Functions
        function refreshAttendance() {
            updateStats();
            updateAttendanceTable();
        }

        function updateStats() {
            const totalUsers = users.length;
            const checkedInUsers = new Set(attendanceLogs.map(log => log.email)).size;
            const checkinRate = totalUsers > 0 ? Math.round((checkedInUsers / totalUsers) * 100) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalCheckedIn').textContent = checkedInUsers;
            document.getElementById('checkinRate').textContent = checkinRate + '%';
        }

        function updateAttendanceTable() {
            const tbody = document.getElementById('attendanceTable');
            
            if (attendanceLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-400">No check-ins yet</td></tr>';
                return;
            }

            // Sort by most recent first
            const sortedLogs = [...attendanceLogs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            tbody.innerHTML = sortedLogs.map(log => `
                <tr class="hover:bg-white hover:bg-opacity-5 transition-colors">
                    <td class="px-6 py-4">${log.email}</td>
                    <td class="px-6 py-4">${new Date(log.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4">
                        <span class="bg-green-500 bg-opacity-20 text-green-300 px-3 py-1 rounded-full text-sm">
                            ‚úÖ Checked In
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function exportToCSV() {
            if (attendanceLogs.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Email', 'Check-in Time', 'Scanned By'];
            const csvContent = [
                headers.join(','),
                ...attendanceLogs.map(log => [
                    log.email,
                    new Date(log.timestamp).toLocaleString(),
                    log.scannedBy || 'Receptionist'
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `beenos-2025-attendance-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                users = [];
                attendanceLogs = [];
                localStorage.removeItem('beenosUsers');
                localStorage.removeItem('beenosAttendanceLogs');
                refreshAttendance();
                alert('All data cleared successfully');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showView('guest');
        });
    </script>
</body>
</html>